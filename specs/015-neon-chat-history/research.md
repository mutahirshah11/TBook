# Research: Neon Postgres Chat History & Query Logging

**Feature**: `015-neon-chat-history`
**Status**: Complete
**Date**: 2025-12-08

## 1. Technical Decisions

### Database Driver
- **Decision**: `asyncpg`
- **Rationale**: It is the fastest asynchronous PostgreSQL driver for Python, designed for high-performance applications. It supports connection pooling and integrates well with modern async frameworks like FastAPI, which is the target backend for this project.
- **Alternatives Considered**: `psycopg2` (synchronous, blocking), `psycopg` (psycopg3 - good, but `asyncpg` is often benchmarked as faster for pure async workloads).

### ID Generation
- **Decision**: UUIDs (v4) generated by the application (Python) or Database (`gen_random_uuid()`).
- **Rationale**: Avoids sequential ID enumeration attacks, allows for decentralized ID generation, and is standard practice for distributed systems.
- **Implementation**: Use Python's `uuid` module for insertion, and define `id` columns as `UUID` type in Postgres.

### Data Storage Format for Chat Context
- **Decision**: `JSONB` column for `used_chunks`.
- **Rationale**: Allows flexible storage of retrieved context (chunks, scores, source metadata) without requiring a rigid schema for every chunk attribute. `JSONB` in Postgres supports efficient indexing and querying if needed later.

### Connection Management
- **Decision**: `asyncpg.create_pool`
- **Rationale**: Creating a new connection for every database operation is expensive. A connection pool maintains a set of open connections that can be reused, significantly improving performance for high-concurrency applications.

## 2. Library Selection

- **Driver**: `asyncpg`
- **Environment Management**: `python-dotenv` (to load `DATABASE_URL`)
- **Logging**: `logging` (Standard Python library)

## 3. Unknowns & Resolutions

- *All critical unknowns were resolved during the specification clarification phase.*
